# Production Dockerfile for Dokploy - Binary Corruption Proof
# This Dockerfile prevents the "corrupted file" error by:
# 1. Using Debian (not Alpine) for better binary compatibility
# 2. Installing OpenSSL explicitly for Prisma
# 3. Force-regenerating Prisma engines
# 4. Never copying node_modules across stages
# 5. Clean builds without cache reuse

FROM node:22-bookworm-slim AS base

WORKDIR /app

# Install system dependencies including OpenSSL (CRITICAL for Prisma)
RUN apt-get update && apt-get install -y \
    openssl \
    ca-certificates \
    python3 \
    make \
    g++ \
    curl \
    && rm -rf /var/lib/apt/lists/*

# Upgrade npm
RUN npm install -g npm@11.8.0

# ============================================
# DEPS STAGE - Install dependencies
# ============================================
FROM base AS deps

WORKDIR /app

# Copy package files only
COPY package.json package-lock.json* ./
COPY turbo.json ./

# Copy package.json files from all packages (for monorepo)
COPY packages/*/package.json ./packages/
COPY apps/*/package.json ./apps/

# CRITICAL: Copy shared config packages (needed during build)
# These must be available before npm ci because other packages reference them
COPY packages/tsconfig ./packages/tsconfig
COPY packages/eslint-config ./packages/eslint-config
COPY packages/prettier-config ./packages/prettier-config
COPY packages/tailwind-config ./packages/tailwind-config

# Install ALL dependencies (including dev for building)
ENV NODE_OPTIONS="--max-old-space-size=2048"
RUN npm ci --legacy-peer-deps

# ============================================
# BUILDER STAGE - Build application
# ============================================
FROM base AS builder

WORKDIR /app

# Copy node_modules from deps stage
COPY --from=deps /app/node_modules ./node_modules

# Copy source code
COPY packages ./packages
COPY apps ./apps
COPY package.json package-lock.json* turbo.json ./
COPY lingui.config.ts ./
COPY tsconfig.json ./

# Set build environment
ARG NODE_ENV=production
ENV NODE_ENV=${NODE_ENV}
ENV NEXT_TELEMETRY_DISABLED=1
ENV NODE_OPTIONS="--max-old-space-size=2048"
# CRITICAL: Add root node_modules/.bin to PATH for workspace binaries
ENV PATH="/app/node_modules/.bin:$PATH"

# CRITICAL: Force clean Prisma generation
# Remove any cached/corrupted Prisma engines
RUN rm -rf node_modules/.prisma
RUN rm -rf packages/prisma/node_modules/.prisma
RUN rm -rf packages/database/node_modules/.prisma

# Generate Prisma Client fresh
RUN npm run prisma:generate

# Build the application (only Remix app and its dependencies)
# This avoids building unused packages like security, performance, etc.
RUN npx turbo run build --filter=@signtusk/remix...

# ============================================
# RUNNER STAGE - Production runtime
# ============================================
FROM base AS runner

WORKDIR /app

ENV NODE_ENV=production
ENV NEXT_TELEMETRY_DISABLED=1
ENV NODE_OPTIONS="--max-old-space-size=512"

# Create non-root user
RUN groupadd --system --gid 1001 nodejs && \
    useradd --system --uid 1001 --gid nodejs nextjs

# Copy package files
COPY --from=builder /app/package.json ./package.json
COPY --from=builder /app/turbo.json ./turbo.json

# CRITICAL: Install production dependencies fresh (no cache reuse)
# This prevents binary corruption from copied node_modules
COPY package-lock.json* ./
RUN npm ci --only=production --legacy-peer-deps

# Copy built application
COPY --from=builder /app/apps/remix/build ./apps/remix/build
COPY --from=builder /app/apps/remix/public ./apps/remix/public
COPY --from=builder /app/apps/remix/package.json ./apps/remix/package.json

# Copy packages (source code needed for imports)
COPY --from=builder /app/packages ./packages

# CRITICAL: Regenerate Prisma Client in production environment
# This ensures binaries match the runtime platform
RUN rm -rf node_modules/.prisma
RUN npx prisma generate

# Create necessary directories
RUN mkdir -p /app/uploads /app/logs && \
    chown -R nextjs:nodejs /app /app/uploads /app/logs

USER nextjs

# Expose ports
EXPOSE 3000 9090

# Health check
HEALTHCHECK --interval=30s --timeout=10s --start-period=40s --retries=3 \
  CMD curl -f http://localhost:3000/health || exit 1

# Start the application
CMD ["npm", "start"]
