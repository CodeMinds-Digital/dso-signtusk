generator kysely {
  provider = "prisma-kysely"
}

generator client {
  provider = "prisma-client-js"
}

generator json {
  provider = "prisma-json-types-generator"
}

generator zod {
  provider             = "zod-prisma-types"
  createInputTypes     = false
  writeBarrelFiles     = false
  useMultipleFiles     = true
  useDefaultValidators = false
}

datasource db {
  provider = "sqlite"
  url      = env("NEXT_PRIVATE_DATABASE_URL")
}

// Todo: (RR7) Remove after RR7 migration.
enum IdentityProvider {
  DOCUMENSO
  GOOGLE
  OIDC
}

enum Role {
  ADMIN
  USER
}

model User {
  id               Int              @id @default(autoincrement())
  name             String?
  email            String           @unique
  password         String?
  emailVerified    DateTime?
  image            String?
  roles            String           @default("USER") // Comma-separated roles for SQLite
  createdAt        DateTime         @default(now())
  updatedAt        DateTime         @updatedAt

  // Relations
  organisations    Organisation[]   @relation("UserOrganisations")
  documents        Document[]
  auditEvents      AuditEvent[]
  
  @@map("users")
}

model Organisation {
  id               Int              @id @default(autoincrement())
  name             String
  slug             String           @unique
  ownerUserId      Int
  createdAt        DateTime         @default(now())
  updatedAt        DateTime         @updatedAt

  // Relations
  owner            User             @relation("UserOrganisations", fields: [ownerUserId], references: [id], onDelete: Cascade)
  teams            Team[]
  
  @@map("organisations")
}

model Team {
  id               Int              @id @default(autoincrement())
  name             String
  organisationId   Int
  createdAt        DateTime         @default(now())
  updatedAt        DateTime         @updatedAt

  // Relations
  organisation     Organisation     @relation(fields: [organisationId], references: [id], onDelete: Cascade)
  documents        Document[]
  
  @@map("teams")
}

model Document {
  id               Int              @id @default(autoincrement())
  title            String
  status           String           @default("DRAFT")
  userId           Int
  teamId           Int
  documentData     Bytes?
  documentMeta     String?          // JSON string for SQLite compatibility
  createdAt        DateTime         @default(now())
  updatedAt        DateTime         @updatedAt

  // Relations
  user             User             @relation(fields: [userId], references: [id], onDelete: Cascade)
  team             Team             @relation(fields: [teamId], references: [id], onDelete: Cascade)
  
  @@map("documents")
}

model AuditEvent {
  id               Int              @id @default(autoincrement())
  type             String
  userId           Int?
  data             String?          // JSON string for SQLite compatibility
  createdAt        DateTime         @default(now())

  // Relations
  user             User?            @relation(fields: [userId], references: [id], onDelete: SetNull)
  
  @@map("audit_events")
}

model VerificationToken {
  id               Int              @id @default(autoincrement())
  identifier       String
  token            String           @unique
  expires          DateTime
  userId           Int?
  createdAt        DateTime         @default(now())

  @@unique([identifier, token])
  @@map("verification_tokens")
}